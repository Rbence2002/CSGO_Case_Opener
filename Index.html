<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Case Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #1b1e23; color: white; margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            background-image: radial-gradient(circle at 50% 0%, #2a2e35 0%, #1b1e23 60%);
            padding-bottom: 50px;
        }
        
        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1b1e23; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .auth-box { background: #23262d; padding: 40px; border-radius: 8px; border: 1px solid #333; text-align: center; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .auth-box input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #454b57; background: #121417; color: white; box-sizing: border-box; }
        .auth-box button { width: 100%; padding: 12px; margin-bottom: 10px; background: #4b69ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;}
        .auth-box button:hover { background: #3b55d9; }
        
        #app-container { display: none; width: 100%; flex-direction: column; align-items: center; }

        /* HUD & Stats */
        .hud { width: 100%; background: rgba(0,0,0,0.6); padding: 15px 30px; box-sizing: border-box; display: flex; justify-content: space-between; border-bottom: 1px solid #333; margin-bottom: 30px; }
        .stats-panel { display: flex; gap: 20px; font-size: 15px; color: #ccc; align-items: center; }
        .stats-panel span { font-weight: bold; color: white; }
        .wallet-bar { display: flex; gap: 30px; font-size: 18px; font-weight: bold; align-items: center; }
        .wallet-val { color: #10b981; }
        .inv-val { color: #3b82f6; }
        
        h1 { margin-top: 0; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .controls { margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
        select, .btn-primary { padding: 12px 20px; font-size: 16px; background-color: #2c3038; color: white; border: 1px solid #454b57; border-radius: 4px; cursor: pointer;}
        .btn-primary { background-color: #4b69ff; border: none; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover { background-color: #3b55d9; }
        .btn-primary:disabled { background-color: #555; cursor: not-allowed; }
        .key-cost { font-size: 14px; color: #888; font-weight: normal; margin-left: -5px;}
        .fast-open-container { display: flex; align-items: center; gap: 8px; font-size: 14px; background: #222; padding: 10px 15px; border-radius: 4px; border: 1px solid #333; }
        
        /* Case Wheel */
        .case-container { width: 900px; height: 220px; background-color: #121417; border: 2px solid #333; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; }
        .center-line { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background-color: #ffd700; transform: translateX(-50%); z-index: 10; box-shadow: 0 0 15px 2px #ffd700; }
        .track { display: flex; height: 100%; width: max-content; }
        .item { width: 170px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #1f2228; border-bottom: 8px solid; box-sizing: border-box; margin-right: 4px; text-align: center; padding: 10px; position: relative; background-image: radial-gradient(circle at 50% 50%, #2a2d35 0%, #1f2228 100%); }
        .item-img { width: 110px; height: 110px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0px 8px 10px rgba(0,0,0,0.6)); }
        .item-name { font-size: 12px; font-weight: 600; text-shadow: 1px 1px 2px black; }
        .wear-label { font-size: 10px; color: #888; margin-top: 5px; }
        .stattrak-tag { color: #cf6a32; font-size: 11px; font-weight: bold; margin-bottom: 5px; }
        
        /* Inventory Section */
        .inventory-section { width: 900px; margin-top: 50px; border-top: 1px solid #333; padding-top: 20px; }
        .inventory-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .inv-item { width: 135px; background: #1f2228; border-bottom: 4px solid; padding: 10px; text-align: center; border-radius: 4px; position: relative; }
        .inv-item img { width: 90px; height: 90px; object-fit: contain; filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.5)); }
        .inv-price { font-size: 13px; font-weight: bold; color: #10b981; margin-top: 5px; }
        .inv-seed { font-size: 9px; color: #666; position: absolute; top: 5px; right: 5px; }
        
        /* Modal Popup */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99; backdrop-filter: blur(5px);}
        #result-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1c20; padding: 40px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.9); z-index: 100; text-align: center; width: 550px; }
        #result-img { width: 250px; height: 250px; object-fit: contain; filter: drop-shadow(0px 15px 20px rgba(0,0,0,0.8)); margin-bottom: 15px;}
        #result-text { font-size: 26px; font-weight: bold; text-shadow: 0px 4px 10px rgba(0,0,0,0.6); margin-bottom: 5px; }
        .result-wear { font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .result-seed { font-size: 12px; color: #777; margin-bottom: 25px; }
        
        .float-container { width: 100%; margin: 15px auto; position: relative; padding-top: 15px; }
        .float-bar { width: 100%; height: 8px; border-radius: 4px; background: linear-gradient(to right, #1b7a2d 0%, #1b7a2d 7%, #64962c 7%, #64962c 15%, #d1ae36 15%, #d1ae36 38%, #c97126 38%, #c97126 45%, #a82a2a 45%, #a82a2a 100%); }
        .float-marker { position: absolute; top: -5px; color: white; font-size: 14px; transform: translateX(-50%); transition: left 1s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .float-labels { display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 5px; }
        
        .action-btns { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .action-btns button { padding: 12px 25px; font-size: 16px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #btn-sell { background-color: transparent; border: 2px solid #10b981; color: #10b981; }
        #btn-sell:hover { background-color: #10b981; color: white; }
        #btn-keep { background-color: #3b82f6; border: none; color: white; }
        #btn-keep:hover { background-color: #2563eb; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h2>CS2 Simulator</h2>
        <div class="auth-box">
            <p style="color: #aaa; font-size: 14px; margin-top: 0;">Enter a username and a secret PIN to play.</p>
            <input type="text" id="username" placeholder="Username (e.g., Player1)">
            <input type="password" id="pin" placeholder="Secret PIN (min 6 characters)">
            
            <button onclick="handleSeamlessAuth(false)">Play / Login</button>
            <button onclick="handleSeamlessAuth(true)" style="background: #2c3038; border: 1px solid #454b57;">Create New Profile</button>
            <p id="auth-msg" style="color: #ef4444; font-size: 13px; margin-bottom: 0;"></p>
        </div>
    </div>

    <div id="app-container">
        <div class="hud">
            <div class="stats-panel">
                <div>Logged in as: <span id="display-username" style="color: #4b69ff;">Guest</span></div>
                <div>Spent: <span id="stat-spent" style="color: #ef4444;">$0.00</span></div>
                <div>Unboxed: <span id="stat-earned" style="color: #10b981;">$0.00</span></div>
                <div>ROI: <span id="stat-roi">0.00%</span></div>
                <div>Knives: <span id="stat-knives" style="color: #ffd700;">0</span></div>
                <button onclick="handleLogout()" style="background: none; border: 1px solid #555; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 20px;">Log Out</button>
            </div>
            <div class="wallet-bar">
                <div>Balance: <span class="wallet-val" id="display-balance">$0.00</span></div>
                <div>Inventory Value: <span class="inv-val" id="display-inv-value">$0.00</span></div>
            </div>
        </div>

        <h1>CS2 Case Simulator</h1>
        
        <div class="controls">
            <select id="case-select">
                <option value="CS:GO Weapon Case">CS:GO Weapon Case (2013)</option>
                <option value="Operation Bravo">Operation Bravo Case (2013)</option>
                <option value="Operation Breakout">Operation Breakout Weapon Case (2014)</option>
                <option value="Chroma Case">Chroma Case (2015)</option>
                <option value="Spectrum Case">Spectrum Case (2017)</option>
                <option value="Dreams & Nightmares">Dreams & Nightmares Case (2022)</option>
                <option value="Revolution Case">Revolution Case (2023)</option>
            </select>
            <button id="open-btn" class="btn-primary">Unlock Container <span class="key-cost">(-$2.49)</span></button>
            <label class="fast-open-container"><input type="checkbox" id="fast-open"> Fast Open</label>
        </div>

        <div class="case-container"><div class="center-line"></div><div class="track" id="track"></div></div>
        
        <div class="inventory-section">
            <h3>Your Kept Items (<span id="inv-count">0</span>)</h3>
            <div class="inventory-grid" id="inventory-grid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay"></div>
    <div id="result-modal">
        <img id="result-img" src="">
        <div id="result-text"></div>
        <div class="result-wear" id="result-wear"></div>
        <div class="result-seed" id="result-seed"></div>
        <div class="float-container">
            <div class="float-bar"></div>
            <div class="float-marker" id="float-marker">▼</div>
            <div class="float-labels"><span>0.0</span><span>0.07</span><span>0.15</span><span>0.38</span><span>0.45</span><span>1.0</span></div>
        </div>
        <div class="action-btns">
            <button id="btn-sell">Sell for $0.00</button>
            <button id="btn-keep">Keep in Inventory</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. SUPABASE CONFIGURATION
        // ==========================================
        const _supabaseUrl = 'https://cifzlvdyadybfnuitgnj.supabase.co'; // <--- REPLACE THIS
        const _supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpZnpsdmR5YWR5YmZudWl0Z25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjM4OTIsImV4cCI6MjA4NzA5OTg5Mn0.GgVXQoZQ5IW30OZPeG8uyCFWdTBE-Tht2BT2JnSeWdo'; //
        const supabase = window.supabase.createClient(_supabaseUrl, _supabaseKey);
        
        let currentUser = null;
        let profile = { username: 'Guest', balance: 0, spent: 0, earned: 0, knives_pulled: 0 };
        let inventory = [];

        // ==========================================
        // 2. SEAMLESS AUTHENTICATION
        // ==========================================
        async function handleSeamlessAuth(isSignUp) {
            const userText = document.getElementById('username').value.trim().toLowerCase();
            const pinText = document.getElementById('pin').value;
            const msgBox = document.getElementById('auth-msg');

            if(!userText || pinText.length < 6) {
                msgBox.innerText = "Please enter a username and a PIN (min 6 characters).";
                return;
            }

            // Silent email format trick
            const fakeEmail = `${userText}@cs2sim.local`;
            msgBox.style.color = "#aaa";
            msgBox.innerText = "Loading...";

            if (isSignUp) {
                const { data, error } = await supabase.auth.signUp({ email: fakeEmail, password: pinText });
                if (error) {
                    msgBox.style.color = "#ef4444";
                    msgBox.innerText = error.message.replace("Email", "Username").replace("email", "username");
                } else {
                    msgBox.style.color = "#10b981";
                    msgBox.innerText = "Profile created! Click Play / Login.";
                }
            } else {
                const { data, error } = await supabase.auth.signInWithPassword({ email: fakeEmail, password: pinText });
                if (error) {
                    msgBox.style.color = "#ef4444";
                    msgBox.innerText = "Invalid Username or PIN.";
                } else {
                    initializeSession(data.user);
                }
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        async function initializeSession(user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Fetch User Profile
            const { data: profData } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if(profData) profile = profData;
            
            // Fetch User Inventory
            const { data: invData } = await supabase.from('inventory').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
            if(invData) inventory = invData;
            
            updateStatsUI();
            renderInventory();
        }

        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) initializeSession(session.user);
        });

        // ==========================================
        // 3. GAME DATA & LOGIC
        // ==========================================
        let IMAGE_MAP = {};
        const FALLBACK_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3QgZmlsbD0iIzJhMmQzNSIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSIyMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjZmZmZmZmIiBmb250LXNpemU9IjYwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPj88L3RleHQ+PC9zdmc+";
        const GOLD_SECRET_IMG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3QgZmlsbD0iIzFmMjIyOCIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIHJ4PSIyMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmaWxsPSIjZmZkNzAwIiBmb250LXNpemU9IjgwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPj88L3RleHQ+PC9zdmc+";

        // Fetch Skin Images
        fetch("https://raw.githubusercontent.com/ByMykel/CSGO-API/main/public/api/en/skins.json")
            .then(res => res.json())
            .then(data => data.forEach(skin => IMAGE_MAP[skin.name] = skin.image));

        const PROBABILITIES = { "Mil-Spec": 0.7992, "Restricted": 0.1598, "Classified": 0.0320, "Covert": 0.0064, "Gold": 0.0026 };
        const COLORS = { "Mil-Spec": "#4b69ff", "Restricted": "#8847ff", "Classified": "#d32ce6", "Covert": "#eb4b4b", "Gold": "#ffd700" };
        const CASES = {
            "CS:GO Weapon Case": { "Mil-Spec": ["MP7 | Skulls", "AUG | Wings", "SG 553 | Ultraviolet"], "Restricted": ["Glock-18 | Dragon Tattoo", "USP-S | Dark Water", "M4A1-S | Dark Water"], "Classified": ["AK-47 | Case Hardened", "Desert Eagle | Hypnotic"], "Covert": ["AWP | Lightning Strike"], "Gold": ["★ Karambit", "★ Bayonet", "★ Flip Knife", "★ Gut Knife", "★ M9 Bayonet"] },
            "Operation Bravo": { "Mil-Spec": ["SG 553 | Wave Spray", "MAC-10 | Graven", "M4A4 | Zirka", "UMP-45 | Bone Pile", "Nova | Tempest", "Galil AR | Shattered"], "Restricted": ["P90 | Emerald Dragon", "USP-S | Overgrowth", "M4A1-S | Bright Water", "AWP | Pit Viper"], "Classified": ["AWP | Graphite", "AK-47 | Fire Serpent"], "Covert": ["Desert Eagle | Golden Koi"], "Gold": ["★ Karambit", "★ Bayonet", "★ Flip Knife", "★ Gut Knife", "★ M9 Bayonet"] },
            "Operation Breakout": { "Mil-Spec": ["MP7 | Urban Hazard", "Negev | Desert-Strike", "P2000 | Ivory", "SSG 08 | Abyss", "UMP-45 | Labyrinth"], "Restricted": ["Glock-18 | Water Elemental", "MAC-10 | Tatter", "P250 | Supernova", "PP-Bizon | Osiris"], "Classified": ["CZ75-Auto | Tigris", "Nova | Antique"], "Covert": ["M4A1-S | Cyrex", "P90 | Asiimov"], "Gold": ["★ Butterfly Knife"] },
            "Chroma Case": { "Mil-Spec": ["Glock-18 | Catacombs", "M249 | System Lock", "MP9 | Deadly Poison", "SCAR-20 | Grotto", "XM1014 | Quicksilver"], "Restricted": ["Desert Eagle | Naga", "Dual Berettas | Urban Shock", "MAC-10 | Malachite", "Sawed-Off | Serenity"], "Classified": ["AK-47 | Cartel", "M4A4 | 龍王 (Dragon King)", "P250 | Muertos"], "Covert": ["Galil AR | Chatterbox", "AWP | Man-o'-war"], "Gold": ["★ Karambit | Doppler", "★ M9 Bayonet | Marble Fade", "★ Bayonet | Tiger Tooth", "★ Flip Knife | Rust Coat"] },
            "Spectrum Case": { "Mil-Spec": ["PP-Bizon | Jungle Slip Sneaky", "SCAR-20 | Blueprint", "Desert Eagle | Oxide Blaze", "Five-SeveN | Capillary", "MP7 | Akoben"], "Restricted": ["MAC-10 | Last Dive", "M249 | Emerald Poison Dart", "Galil AR | Crimson Tsunami", "UMP-45 | Scaffold"], "Classified": ["M4A1-S | Decimator", "AWP | Fever Dream", "CZ75-Auto | Xiangliu"], "Covert": ["AK-47 | Bloodsport", "USP-S | Neo-Noir"], "Gold": ["★ Butterfly Knife | Marble Fade", "★ Huntsman Knife | Doppler", "★ Falchion Knife | Tiger Tooth"] },
            "Dreams & Nightmares": { "Mil-Spec": ["MAG-7 | Foresight", "SCAR-20 | Poultrygeist", "Sawed-Off | Spirit Board", "P2000 | Lifted Spirits", "MP7 | Abyssal Apparition"], "Restricted": ["MAC-10 | Ensnared", "PP-Bizon | Space Cat", "USP-S | Ticket to Hell", "Five-SeveN | Scrawl", "G3SG1 | Dream Glade"], "Classified": ["Dual Berettas | Melondrama", "FAMAS | Rapid Eye Movement", "M4A1-S | Night Terror"], "Covert": ["AK-47 | Nightwish", "MP9 | Starlight Protector"], "Gold": ["★ Butterfly Knife | Gamma Doppler", "★ Huntsman Knife | Autotronic", "★ Shadow Daggers | Lore"] },
            "Revolution Case": { "Mil-Spec": ["MP9 | Featherweight", "MAG-7 | Insomnia", "SCAR-20 | Fragments", "P250 | Re.built", "MP5-SD | Liquidation", "SG 553 | Cyberforce"], "Restricted": ["Glock-18 | Umbral Rabbit", "MAC-10 | Sakkaku", "R8 Revolver | Banana Cannon", "M4A1-S | Emphorosaur-S", "P2000 | Wicked Sick"], "Classified": ["UMP-45 | Wild Child", "P90 | Neoqueen", "AWP | Duality"], "Covert": ["M4A4 | Temukau", "AK-47 | Head Shot"], "Gold": ["★ Talon Knife", "★ Skeleton Knife", "★ Nomad Knife", "★ Survival Knife", "★ Paracord Knife"] }
        };

        function getBasePrice(rarity) {
            const prices = { "Mil-Spec": [0.10, 1.50], "Restricted": [2.00, 8.00], "Classified": [10.00, 40.00], "Covert": [50.00, 250.00], "Gold": [300.00, 2000.00] };
            const [min, max] = prices[rarity]; return (Math.random() * (max - min)) + min;
        }

        // NOTE: Case math is executed securely here! Do not modify this nerd!
        function rollItem(caseName) {
            const roll = Math.random();
            let cumulative = 0; let selectedRarity = "Mil-Spec";
            
            for (const [rarity, prob] of Object.entries(PROBABILITIES)) {
                cumulative += prob;
                if (roll <= cumulative) { selectedRarity = rarity; break; }
            }
            
            const itemsInTier = CASES[caseName][selectedRarity];
            const baseName = itemsInTier[Math.floor(Math.random() * itemsInTier.length)];
            const isStattrak = Math.random() <= 0.10;
            
            const floatVal = Math.random();
            let wear = "Battle-Scarred", wMult = 0.5;
            if (floatVal < 0.07) { wear = "Factory New"; wMult = 2.0; }
            else if (floatVal < 0.15) { wear = "Minimal Wear"; wMult = 1.5; }
            else if (floatVal < 0.38) { wear = "Field-Tested"; wMult = 1.0; }
            else if (floatVal < 0.45) { wear = "Well-Worn"; wMult = 0.8; }

            const patternSeed = Math.floor(Math.random() * 1000) + 1;

            let apiLookupName = baseName;
            if (selectedRarity === "Gold" && !baseName.includes("|")) apiLookupName = `★ ${baseName.replace("★ ", "")} | Vanilla`;
            const imgUrl = IMAGE_MAP[apiLookupName] || IMAGE_MAP[baseName] || FALLBACK_IMG;
            
            let fullName = baseName;
            if (isStattrak) fullName = selectedRarity === "Gold" ? baseName.replace("★ ", "★ StatTrak™ ") : `StatTrak™ ${baseName}`;
                
            let marketValue = getBasePrice(selectedRarity) * wMult;
            if (isStattrak) marketValue *= 2.5;
            if (baseName.includes("Case Hardened") && [661, 387, 321].includes(patternSeed)) marketValue *= 50.0;

            return {
                base_name: baseName, full_name: fullName, wear: wear, float_val: parseFloat(floatVal.toFixed(7)),
                pattern: patternSeed, rarity: selectedRarity, color: COLORS[selectedRarity], 
                image_url: imgUrl, value: parseFloat(marketValue.toFixed(2)), is_stattrak: isStattrak
            };
        }

        // ==========================================
        // 4. UI ANIMATION & DATABASE SYNC
        // ==========================================
        let currentWinner = null;
        
        async function syncProfile() {
            updateStatsUI();
            await supabase.from('profiles').update({
                balance: profile.balance, spent: profile.spent, 
                earned: profile.earned, knives_pulled: profile.knives_pulled
            }).eq('id', currentUser.id);
        }

        function updateStatsUI() {
            document.getElementById('display-username').innerText = profile.username;
            document.getElementById('display-balance').innerText = `$${profile.balance.toFixed(2)}`;
            const invVal = inventory.reduce((sum, item) => sum + parseFloat(item.value), 0);
            document.getElementById('display-inv-value').innerText = `$${invVal.toFixed(2)}`;
            document.getElementById('inv-count').innerText = inventory.length;
            document.getElementById('stat-spent').innerText = `-$${profile.spent.toFixed(2)}`;
            document.getElementById('stat-earned').innerText = `$${profile.earned.toFixed(2)}`;
            document.getElementById('stat-knives').innerText = profile.knives_pulled;
            const roi = profile.spent > 0 ? ((profile.earned / profile.spent) * 100) : 0;
            const roiEl = document.getElementById('stat-roi');
            roiEl.innerText = `${roi.toFixed(1)}%`;
            roiEl.style.color = roi >= 100 ? '#10b981' : '#ef4444';
        }

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = inventory.map(item => `
                <div class="inv-item" style="border-bottom-color: ${item.color}">
                    <div class="inv-seed">#${item.pattern}</div>
                    <img src="${item.image_url}" onerror="this.src=fallbackSrc">
                    <div class="item-name" style="color: ${item.color}">${item.base_name}</div>
                    <div class="inv-price">$${parseFloat(item.value).toFixed(2)}</div>
                </div>
            `).join('');
        }

        function playOriginalSound(filename) {
            new Audio(`./static/${filename}`).play().catch(e => {});
        }

        function showResultModal(winner) {
            currentWinner = winner;
            playOriginalSound('reveal.wav');
            
            profile.earned += winner.value;
            if(winner.rarity === 'Gold') profile.knives_pulled++;
            syncProfile(); 
            
            document.getElementById('result-img').src = winner.image_url;
            document.getElementById('result-text').innerHTML = winner.full_name;
            document.getElementById('result-text').style.color = winner.color;
            document.getElementById('result-wear').innerHTML = `${winner.wear} (Float: ${winner.float_val})`;
            document.getElementById('result-seed').innerHTML = `Pattern Template: ${winner.pattern}`;
            document.getElementById('float-marker').style.left = `${winner.float_val * 100}%`;
            document.getElementById('btn-sell').innerText = `Sell for $${winner.value.toFixed(2)}`;
            
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('result-modal').style.display = 'block';
        }

        document.getElementById('open-btn').addEventListener('click', async () => {
            if(profile.balance < 2.49) return alert("Insufficient funds! Sell items to afford a key.");
            
            profile.balance -= 2.49;
            profile.spent += 2.49;
            syncProfile();
            
            const btn = document.getElementById('open-btn');
            const track = document.getElementById('track');
            btn.disabled = true;
            track.style.transition = 'none'; track.style.transform = `translateX(0px)`;
            
            const caseName = document.getElementById('case-select').value;
            const sequence = Array.from({length: 55}, () => rollItem(caseName));
            const winner = sequence[45];
            
            if(document.getElementById('fast-open').checked) {
                showResultModal(winner);
                return;
            }
            
            track.innerHTML = sequence.map(item => {
                const isGold = item.rarity === 'Gold';
                const img = isGold ? goldSecretSrc : item.image_url;
                const name = isGold ? '★ Rare Special Item ★' : item.base_name;
                const st = (item.is_stattrak && !isGold) ? `<div class="stattrak-tag">StatTrak™</div>` : '';
                return `<div class="item" style="border-bottom-color: ${item.color}">${st}<img src="${img}" class="item-img" onerror="this.src=fallbackSrc"><div class="item-name" style="color: ${item.color}">${name}</div></div>`;
            }).join('');
            
            void track.offsetWidth; 
            const finalPosition = -(45 * 174) + 450 - (174 / 2) + (Math.floor(Math.random() * 120) - 60);
            
            track.style.transition = 'transform 6.5s cubic-bezier(0.1, 0.9, 0.15, 1)';
            track.style.transform = `translateX(${finalPosition}px)`;
            
            let delay = 30; let elapsed = 0;
            (function tick() {
                playOriginalSound('scroll.wav');
                elapsed += delay; delay *= 1.075; 
                if (elapsed < 6200) setTimeout(tick, delay);
            })();
            
            setTimeout(() => showResultModal(winner), 6800);
        });

        document.getElementById('btn-sell').addEventListener('click', () => {
            profile.balance += currentWinner.value;
            syncProfile();
            closeModal();
        });

        document.getElementById('btn-keep').addEventListener('click', async () => {
            document.getElementById('btn-keep').disabled = true;
            document.getElementById('btn-keep').innerText = "Saving...";
            
            const itemToSave = { 
                user_id: currentUser.id, base_name: currentWinner.base_name, 
                full_name: currentWinner.full_name, wear: currentWinner.wear, 
                float_val: currentWinner.float_val, pattern: currentWinner.pattern, 
                rarity: currentWinner.rarity, color: currentWinner.color, 
                image_url: currentWinner.image_url, value: currentWinner.value 
            };
            
            inventory.unshift(itemToSave);
            await supabase.from('inventory').insert([itemToSave]);
            
            updateStatsUI();
            renderInventory();
            closeModal();
        });

        function closeModal() {
            document.getElementById('result-modal').style.display = 'none';
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('open-btn').disabled = false;
            document.getElementById('btn-keep').disabled = false;
            document.getElementById('btn-keep').innerText = "Keep in Inventory";
        }
    </script>
</body>
</html>